name: Publish Clean Version to Public Repo

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4

      - name: Create clean version
        run: |
          mkdir clean-version
      
          # Copier tout sauf les fichiers sensibles
          rsync -av --exclude='.git' \
                    --exclude='src/main/resources/application.properties' \
                    --exclude='src/main/resources/application-dev.properties' \
                    --exclude='src/main/resources/application-local.properties' \
                    --exclude='src/main/resources/application-preprod.properties' \
                    --exclude='src/main/resources/application-prod.properties' \
                    ./ ./clean-version/
      
          # Remplacer application.properties par l'exemple
          cp src/main/resources/application-example.properties clean-version/src/main/resources/application.properties
      
          # Supprimer le contenu des dossiers sensibles, mais laisser les dossiers
          rm -rf clean-version/src/main/resources/key/*
          rm -rf clean-version/src/main/resources/ssl-certificate/*
          touch clean-version/src/main/resources/key/.gitkeep
          touch clean-version/src/main/resources/ssl-certificate/.gitkeep
      
          # Supprimer tout historique Git Ã©ventuel (trÃ¨s important !)
          rm -rf clean-version/.git

      - name: Init Git repo in cleaned version
        working-directory: clean-version
        run: |
          git init
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add .
          git commit -m "ðŸš€ Cleaned public version"

      - name: Push to public repository
        working-directory: clean-version
        run: |
          REPO_URL="https://x-access-token:${{ secrets.GH_PUBLIC_TOKEN }}@github.com/praticbouticpublic/backend.git"
          echo "ðŸ§ª Pushing to $REPO_URL"
          git remote add origin "$REPO_URL"
          git branch -M main
          git push -f origin main


