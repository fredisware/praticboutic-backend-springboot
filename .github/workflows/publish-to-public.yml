name: ğŸš€ Publish to Public Repo

on:
  workflow_dispatch: # Tu veux le lancer Ã  la mano

jobs:
  publish:
    name: ğŸ“¤ Clean & Push to Public Repo
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§½ Checkout Private Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Clean Sensitive Files
        run: |
          rm -rf src/test/resources/key/*.json
          sed -i '/stripe\.secret-key/d' src/test/resources/application*.properties
          sed -i '/stripe\.test-secret-key/d' src/test/resources/application*.properties
          sed -i '/GOOGLE_APPLICATION_CREDENTIALS/d' src/test/resources/application*.properties
          sed -i '/GOOGLE_APPLICATION_CREDENTIALS/d' src/main/resources/application*.properties
          rm -f src/test/resources/application*.bak

      - name: ğŸ“ Copy Cleaned Code to Temp Directory
        run: |
          mkdir cleaned
          rsync -av --progress . cleaned --exclude .git --exclude cleaned

      - name: ğŸ§ª Init & Push to Public Repo
        working-directory: cleaned
        env:
          GH_PUBLIC_TOKEN: ${{ secrets.GH_PUBLIC_TOKEN }}
        run: |
          git init
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "ğŸ§¼ Clean public version without secrets"
          git branch -M main
          git remote add origin https://x-access-token:${GH_PUBLIC_TOKEN}@github.com/praticbouticpublic/backend.git
          git push -f origin main

