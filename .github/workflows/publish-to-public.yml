name: Publish Clean Public Repo

on:
  push:
    branches:
      - main  # ou ta branche principale

jobs:
  clean-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Prepare clean version without secrets
      run: |
        mkdir cleaned
        rsync -av --exclude='.git' ./ ./cleaned/
        
        # Remove secret files and test files containing secrets
        rm -f cleaned/src/test/resources/application*.properties
        rm -f cleaned/src/test/resources/application.properties.bak
        rm -f cleaned/src/test/java/com/ecommerce/**/PraticbouticBackendJavaApplicationTests.java
        rm -f cleaned/src/test/resources/key/*.json
        
        # Clear key and ssl-certificate folders but keep the folders
        rm -rf cleaned/src/test/resources/key/*
        rm -rf cleaned/src/test/resources/ssl-certificate/*
        mkdir -p cleaned/src/test/resources/key
        mkdir -p cleaned/src/test/resources/ssl-certificate
        touch cleaned/src/test/resources/key/.gitkeep
        touch cleaned/src/test/resources/ssl-certificate/.gitkeep
        
        # Remove old Git history in cleaned folder
        rm -rf cleaned/.git

    - name: Push cleaned version to public repo
      working-directory: cleaned
      env:
        REPO_URL: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/praticbouticpublic/backend.git
      run: |
        git init
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "ðŸ§¼ Clean public version without secrets"
        git branch -M main
        git remote add origin "$REPO_URL"
        git push -f origin main


